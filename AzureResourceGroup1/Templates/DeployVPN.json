{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "virtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "Name of the VNet."
      }
    },
    "virtualNetworkAddressRange": {
      "type": "string",
      "metadata": { "description": "The address range of the new VNET in CIDR format" },
      "defaultValue": "10.199.0.0/16"
    },
    "deploymentNumber": {
      "type": "string",
      "defaultValue": "1",
      "metadata": { "description": "When deploying the stack N times, define the instance - this will be appended to some resource names to avoid collisions." }
    },
    "subnets": {
      "type": "array",
      "defaultValue": "[concat('adSubnet', parameters('deploymentNumber'))]"
    },
    "GatewaySubnetAddressRange": {
      "type": "string",
      "defaultValue": "10.199.0.0/24",
      "metadata": {
        "description": "The prefix for the GatewaySubnet where the VirtualNetworkGateway will be deployed. This must be at least /29."
      }
    },
    "gatewayPublicIPName": {
      "type": "string",
      "defaultValue": "VNetPIP",
      "metadata": {
        "description": "The name of the PublicIP attached to the VirtualNetworkGateway."
      }
    },
    "gatewayName": {
      "type": "string",
      "metadata": {
        "description": "The name of the VirtualNetworkGateway."
      }
    },
    "gatewaySku": {
      "type": "string",
      "defaultValue": "Basic",
      "metadata": {
        "description": "The Sku of the Gateway. This must be one of Basic, Standard or HighPerformance."
      }
    },
    "vpnClientAddressPoolPrefix": {
      "type": "string",
      "defaultValue": "192.168.254.0/24",
      "metadata": {
        "description": "The IP address range from which VPN clients will receive an IP address when connected. Range specified must not overlap with on-premise network."
      }
    }
  },
  "variables": {
    "gatewaySubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), 'GatewaySubnet')]",
    "adSubnetID": "[concat(variables('vnetID'),'/subnets/', variables('adSubnetName'))]",
    "adSubnetName": "[parameters('subnets')[0].name]",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
    "clientRootCertData": "MIIInDCCBoSgAwIBAgITMQAAAAX5ZJQOTsW6RgAAAAAABTANBgkqhkiG9w0BAQ0F ADAaMRgwFgYDVQQDEw9OQUdBU0VTLVJPT1QtQ0EwHhcNMTkwMTExMTM1MTI1WhcN MjgwNDE2MTUyNDQyWjBPMRMwEQYKCZImiZPyLGQBGRYDZ3JwMRcwFQYKCZImiZPy LGQBGRYHbmFnYXNlczEfMB0GA1UEAxMWTkFHQVNFUy1JU1NVSU5HLUVYVC1DQTCC AiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAPSvzIYXK2qHPgYjq8/ukFdy AU9SWT6v8o1JaCye81gcnice/SDoos9TWfBTk2vHLJqehkIiw4aHcuSPwixEkeJC imQtly1HhHzg6YxwDop8FBKmT6vD1mo0k+PfjvsWOg/0x6OToINCHG9WCG8NaaJj ZbSCE4Xism/RDgeYmWEJmOwV8fNIZg6Lxb2IEdXFknisJM3g1eml3DJYr+x+D380 buZoVJDFeY3s3TgfWFe5CK5NdUdA3/f/hmZgDeFVoNPKokiy0ltrwM7q4Udhg6zf 5yKok9UwysuzGyLaOsm/Zy6HziE+sENf/jEXqmqtFyxdnyVcdrV5hpkZlPKryRfK 1fyGwHCA/IgKqozgOwk/JQtBteRlSkTXIk12l8Pa+UPUeR6bzcVt2wEldRoJIYLR 7cieq47oYU39BY7EgmaSbXFNbOp4+UV6G4QjWZJeuGtOwUcubsL5Ek3tlEBMi/8h eAjD2WPUBB8bLJbNE8je2jl0zF1m9n9P2levqChMlwnC9V/U/wVPfRLw63K3ofjl l2hKn+BRdEMHkzMeh36DIbpUyydJAimBaf4Gq6q5LviWdCwHE3R+gOXztf/SFDOc Izg0t3oPq/k2p8q5zwDUpSN1evmbQGNQti09pSKZWconeZTcFw/QmQn6tAzP654s Zo1huhYh0U6bpvE81MqZAgMBAAGjggOkMIIDoDAQBgkrBgEEAYI3FQEEAwIBADAd BgNVHQ4EFgQUEHHRney3ZXdsjmhl2Jkz/bOdZWwwgd4GA1UdIASB1jCB0zCB0AYK KwYBCWSCOIEIDjCBwTCBvgYIKwYBBQUHAgIwgbEega4AVABoAGkAcwAgAEMAQQAg AGkAcwAgAGYAbwByACAASQBuAHQAZQByAG4AYQBsACAAdQBzAGUAIABvAG4AbAB5 AC4AIABQAGwAZQBhAHMAZQAgAGMAbABpAGMAawAgAG8AbgAgAHQAaABlACAATQBv AHIAZQAgAEkAbgBmAG8AIABiAHUAdAB0AG8AbgAgAHQAbwAgAG8AcABlAG4AIAB0 AGgAZQAgAEMAUABTAC4wGQYJKwYBBAGCNxQCBAweCgBTAHUAYgBDAEEwCwYDVR0P BAQDAgGGMA8GA1UdEwEB/wQFMAMBAf8wHwYDVR0jBBgwFoAUTgqE0mfPvSxRAaA0 sFFLdVcHmoEwggETBgNVHR8EggEKMIIBBjCCAQKggf+ggfyGgb9sZGFwOi8vL0NO PU5BR0FTRVMtUk9PVC1DQSxDTj1NRVdSMDBQS0lSMDEsQ049Q0RQLENOPVB1Ymxp YyUyMEtleSUyMFNlci12aWNlcyxDTj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9u LERDPU5BR0FTRVMsREM9R1JQJTIwP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/ YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0cmlidXRpb25Qb2ludIY4aHR0cDovL2Ny bGVudC5uYWdhc2VzLmNvbS9jZXJ0ZW5yb2xsL05BR0FTRVMtUk9PVC1DQS5jcmww ggEZBggrBgEFBQcBAQSCAQswggEHMIGxBggrBgEFBQcwAoaBpGxkYXA6Ly8vQ049 TkFHQVNFUy1ST09ULUNBLENOPUFJQSxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNl cyxDTj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPU5BR0FTRVMsREM9R1JQ JTIwP2NBQ2VydGlmaWNhdGU/YmFzZT9vYmplY3RDbGFzcz1jZXJ0aWZpY2F0aW9u QXV0aG9yaXR5MFEGCCsGAQUFBzAChkVodHRwOi8vY3JsZW50Lm5hZ2FzZXMuY29t L0NlcnRFbnJvbGwvTUVXUjAwUEtJUjAxX05BR0FTRVMtUk9PVC1DQS5jcnQwDQYJ KoZIhvcNAQENBQADggIBALtpOWoJHKqBcg6zom1nMwUdaRA6JFsuQE9uRljmZejU P34bD9XM0L6O5EDd1n5DVz1Fs/CGypIc7GevXiaO2/Nhs4JxNp8bDyG52Hno64Pn tj6w0ljDqI6X06Nq1Vkfz27OTrYrBYpg7t4EFmcZeadYi7y8a1X+OLBInssMe/Sw ctVzZw3NuUpH7qYGaeiB39nd349ASx8T4vIturpzYfAJ6X+NWz/BnbVgGfWou3XJ xAYiV5AQtDCyqvdctuOIUgAg5vW8I5VSZ6CVfBp10yno1Hg3Z5xBhPcPyNAWG0Dz aEfZkHANl9ul2YpI8KDL4II3X/cMmFABI152tRMYXaeg8gAm456xyigxu/w9JrVh Dnt+GbIe+IT3nejkq/7n8yDjxfrDuMmi0+FLqcQ9hcrlj/Kcs21tiiydJAgJN9FX wOpOpw/XmTShr5ofQMIlz3cl4T9KvDylQPfCk91ozmWY9y8O6UXr791xELYCXjK1 zXWhCphlOAirBUVHs8m12xSou3V+417A1aMlwamP5L4zJMYFrcrN8On6VMg2/iFt mWk1zbbzJq2S6RZ4IvJrFpry2sS9xyA5VnxIvf0rvWug9LN08AqBs0Ebx5jKgeCt 0ULQL3xx9/I8noLxTHpb7l/xsiaUPuM4Zoq+TIS+AOc130tYPXrROCfJVsP2z4UJ",
    "clientRootCertName": "NAGASES-ISSUING-EXT-CA"
  },
  "resources": [
    {
      "apiVersion": "2018-04-01",
      "type": "Microsoft.Network/virtualNetworkGateways",
      "name": "[parameters('gatewayName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "ipConfigurations": [
          {
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "[variables('gatewaySubnetRef')]"
              },
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',parameters('gatewayPublicIPName'))]"
              }
            },
            "name": "vnetGatewayConfig"
          }
        ],
        "sku": {
          "name": "[parameters('gatewaySku')]",
          "tier": "[parameters('gatewaySku')]"
        },
        "gatewayType": "Vpn",
        "vpnType": "RouteBased",
        "enableBgp": "false",
        "vpnClientConfiguration": {
          "vpnClientAddressPool": {
            "addressPrefixes": [
              "[parameters('vpnClientAddressPoolPrefix')]"
            ]
          },
          "vpnClientRootCertificates": [
            {
              "name": "[variables('clientRootCertName')]",
              "properties": {
                "PublicCertData": "[variables('clientRootCertData')]"
              }
            }
          ]
        }
      }
    }
  ]
}
  